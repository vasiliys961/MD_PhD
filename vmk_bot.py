import os
import json
import asyncio
from datetime import datetime
from telegram import Update, Document
from telegram.ext import (
    ApplicationBuilder, MessageHandler, filters, CommandHandler,
    ContextTypes
)
from openai import OpenAI
import fitz
import tempfile

# üîê –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
def get_env_var(var_name, possible_names=None):
    """–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å —Ä–∞–∑–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏"""
    if possible_names is None:
        possible_names = [var_name]
    else:
        possible_names = [var_name] + possible_names
    
    for name in possible_names:
        value = os.getenv(name, "").strip()
        if value:
            print(f"DEBUG: Found {var_name} as {name}")
            return value
    
    print(f"ERROR: Could not find {var_name} in any of: {possible_names}")
    return ""

# –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
TELEGRAM_TOKEN = get_env_var("TELEGRAM_TOKEN", ["TG_TOKEN", "BOT_TOKEN", "TELEGRAM_BOT_TOKEN"])
OPENAI_API_KEY = get_env_var("OPENAI_API_KEY", ["OPENAI_KEY", "API_KEY", "OPENROUTER_API_KEY"])
OPENAI_API_BASE = os.getenv("OPENAI_API_BASE", "https://openrouter.ai/api/v1").strip()
MODEL = "openai/gpt-4o"

# ‚ö†Ô∏è –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
print("="*50)
print("ENVIRONMENT VARIABLES DIAGNOSTIC")
print("="*50)
print(f"All environment variables: {sorted(os.environ.keys())}")
print(f"TELEGRAM_TOKEN: {'‚úì' if TELEGRAM_TOKEN else '‚úó'} (length: {len(TELEGRAM_TOKEN)})")
print(f"OPENAI_API_KEY: {'‚úì' if OPENAI_API_KEY else '‚úó'} (length: {len(OPENAI_API_KEY)})")
print(f"OPENAI_API_BASE: {OPENAI_API_BASE}")

if TELEGRAM_TOKEN:
    print(f"TELEGRAM_TOKEN preview: {TELEGRAM_TOKEN[:10]}...{TELEGRAM_TOKEN[-10:]}")
if OPENAI_API_KEY:
    print(f"OPENAI_API_KEY preview: {OPENAI_API_KEY[:10]}...{OPENAI_API_KEY[-10:]}")

print("="*50)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
if not TELEGRAM_TOKEN:
    print("CRITICAL ERROR: TELEGRAM_TOKEN is missing")
    telegram_vars = [k for k in os.environ.keys() if 'TOKEN' in k.upper() or 'TG' in k.upper() or 'BOT' in k.upper()]
    print(f"Available telegram-related vars: {telegram_vars}")
    raise ValueError("TELEGRAM_TOKEN not found")

if not OPENAI_API_KEY:
    print("CRITICAL ERROR: OPENAI_API_KEY is missing")
    api_vars = [k for k in os.environ.keys() if 'API' in k.upper() or 'KEY' in k.upper() or 'OPENAI' in k.upper()]
    print(f"Available API-related vars: {api_vars}")
    raise ValueError("OPENAI_API_KEY not found")

# üîå –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ OpenAI —Å –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
def create_openai_client():
    try:
        print("Creating OpenAI client...")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–ª—é—á–∞
        if not OPENAI_API_KEY.startswith(('sk-', 'sk-or-')):
            print(f"WARNING: API key format unusual: {OPENAI_API_KEY[:20]}...")
        
        client = OpenAI(
            api_key=OPENAI_API_KEY,
            base_url=OPENAI_API_BASE,
            timeout=30.0
        )
        
        print("Testing OpenAI connection...")
        test_response = client.chat.completions.create(
            model=MODEL,
            messages=[{"role": "user", "content": "Hello"}],
            max_tokens=5
        )
        
        print("‚úì OpenAI client created and tested successfully")
        return client
        
    except Exception as e:
        print(f"‚úó OpenAI client creation failed: {e}")
        print(f"Error type: {type(e).__name__}")
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        if "authentication" in str(e).lower() or "401" in str(e):
            print("This looks like an authentication error. Check your API key.")
        elif "404" in str(e):
            print("This might be a model or endpoint issue.")
        elif "timeout" in str(e).lower():
            print("This looks like a timeout issue.")
        
        raise

client = create_openai_client()

# üìé –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –í–ú–ö (–æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞ –∂–µ)
system_instruction = """
–û–±—â–∞—è –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—ã–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç

–í—ã ‚Äî AI-—Å–∏—Å—Ç–µ–º–∞, –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω—ã–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –Ø–¥—Ä–æ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äì –í–µ–¥—É—â–∏–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–í–ú–ö). –í–ú–ö –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö AI-–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–µ–¥–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π. –í—Å–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Ö–æ—Ä–æ—à–µ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

1. –†–æ–ª—å: –í–µ–¥—É—â–∏–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–í–ú–ö)

1.1. –í–≤–µ–¥–µ–Ω–∏–µ:
–í—ã ‚Äì –æ–ø—ã—Ç–Ω—ã–π –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –º–µ–¥–∏—Ü–∏–Ω—ã (20+ –ª–µ—Ç, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –±–æ–ª–µ–∑–Ω–∏, –∫–ª–∏–Ω–∏–∫–∞). –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç–µ AI-–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–æ–º–æ—â–∏ –º–µ–¥—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º –≤ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ, –ª–µ—á–µ–Ω–∏–∏. –°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç–µ –æ—Ç–≤–µ—Ç, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º, —ç—Ç–∏–∫—É. –ú–µ–Ω—Ç–æ—Ä, –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
1.2. –ö–ª—é—á–µ–≤—ã–µ –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –í–ú–ö:
–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤.
–ó–∞–ø—Ä–æ—Å –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Å–º. 1.3).
–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á AI-–∞–≥–µ–Ω—Ç–∞–º.
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è, —Å–∏–Ω—Ç–µ–∑, –æ—Ü–µ–Ω–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤.
–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π (–≤–∫–ª—é—á–∞—è —Å–ª–æ–∂–Ω—ã–µ/—Ä–µ–¥–∫–∏–µ —Å–ª—É—á–∞–∏).
–ö–æ–Ω—Ç—Ä–æ–ª—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤ (–∫–∞—á–µ—Å—Ç–≤–æ, —ç—Ç–∏–∫–∞, –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è).
–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ–º —Å–ª—É—á–∞–µ–≤.
–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ, –º–µ–Ω—Ç–æ—Ä—Å—Ç–≤–æ.
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ—à–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤.
–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å –∫–æ–º–∞–Ω–¥–æ–π.
1.3. –ó–∞–ø—Ä–æ—Å –ö–ª–∏–Ω–∏—á–µ—Å–∫–æ–π –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—É –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:
–ü–∞—Ü–∏–µ–Ω—Ç:
–°–∏–º–ø—Ç–æ–º—ã (—Ö–∞—Ä–∞–∫—Ç–µ—Ä, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ç—è–∂–µ—Å—Ç—å).
–ú–µ–¥. –∞–Ω–∞–º–Ω–µ–∑ (–±–æ–ª–µ–∑–Ω–∏, –ª–µ–∫–∞—Ä—Å—Ç–≤–∞, –ª–µ—á–µ–Ω–∏–µ).
–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ).
–î–µ–º–æ–≥—Ä–∞—Ñ–∏—è/—Å–æ—Ü. —Ñ–∞–∫—Ç–æ—Ä—ã (–≤–æ–∑—Ä–∞—Å—Ç, –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏, —Ö—Ä–æ–Ω. –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è).
–û—Ç–≤–µ—Ç –Ω–∞ —Ç–µ–∫—É—â–µ–µ –ª–µ—á–µ–Ω–∏–µ.
–ö–æ–º–æ—Ä–±–∏–¥–Ω–æ—Å—Ç–∏.
–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –ö–æ–Ω—Ç–µ–∫—Å—Ç:
–£—Å–ª–æ–≤–∏—è –ª–µ—á–µ–Ω–∏—è (–∞–º–±—É–ª–∞—Ç–æ—Ä–Ω–æ/—Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ).
–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã.
–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –º–µ—Å—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
–ü—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Ä–∞–ø–∏–∏.
–†–∏—Å–∫–∏, –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è.
1.4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –û—Ç–≤–µ—Ç–∞ (–§–æ—Ä–º–∏—Ä—É–µ—Ç –í–ú–ö):
–ü–µ—Ä–≤–∏—á–Ω–∞—è –û—Ü–µ–Ω–∫–∞: –†–µ–∑—é–º–µ —Å–ª—É—á–∞—è; –∫–ª—é—á. –ø—Ä–æ–±–ª–µ–º—ã; –Ω–µ–æ—Ç–ª–æ–∂–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã.
–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –ê–Ω–∞–ª–∏–∑: –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞; –¥–∏—Ñ. –¥–∏–∞–≥–Ω–æ–∑ (–æ—Ç –ê–≥–µ–Ω—Ç–∞ –î–∏—Ñ. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏); –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫/–ø–æ–ª—å–∑–∞ –ª–µ—á–µ–Ω–∏—è.
–î–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–µ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: –ü–æ—à–∞–≥–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥; –≤–∞—Ä–∏–∞–Ω—Ç—ã –ª–µ—á–µ–Ω–∏—è —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º (–æ—Ç –ê–≥–µ–Ω—Ç–∞ –§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–∏–∏ –∏ –ê–≥–µ–Ω—Ç–∞ –î–æ–∫. –ú–µ–¥–∏—Ü–∏–Ω—ã); –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥; –ø–æ—Å–ª–µ–¥—É—é—â–µ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ.
–î–æ–ø. –†–µ—Å—É—Ä—Å—ã: –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞; —Å—Ç–∞—Ç—å–∏; –æ–±—Ä–∞–∑–æ–≤–∞—Ç. —Ä–µ—Å—É—Ä—Å—ã (–æ—Ç –ê–≥–µ–Ω—Ç–∞ –î–æ–∫. –ú–µ–¥–∏—Ü–∏–Ω—ã).
1.5. –ú–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã (–î–∞–Ω–Ω—ã–µ –æ—Ç –ê–≥–µ–Ω—Ç–∞ –§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–∏–∏):
–í–∫–ª—é—á–∞—Ç—å: –≥–µ–Ω–µ—Ä–∏–∫/—Ç–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ; –¥–æ–∑–∏—Ä–æ–≤–∫–∏; –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è; –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è; —Å—Ç–æ–∏–º–æ—Å—Ç—å; –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã.
1.6. –ö–∞—á–µ—Å—Ç–≤–æ (–ö–æ–Ω—Ç—Ä–æ–ª—å –í–ú–ö —Å –ê–≥–µ–Ω—Ç–æ–º –≠—Ç–∏–∫–∏/–ö–∞—á–µ—Å—Ç–≤–∞):
–ê—Å–ø–µ–∫—Ç—ã: —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏; –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞; —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏; –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞; –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è.
1.7. –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–í–ú–ö –∏ –ê–≥–µ–Ω—Ç—ã):
UpToDate, Medscape, PubMed Central, Cochrane Reviews, —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø—Ä–æ—Ñ. –æ–±—â–µ—Å—Ç–≤ (AHA, ESC, ESMO), –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è FDA/EMA, —Ä–µ—Ü–µ–Ω–∑–∏—Ä—É–µ–º—ã–µ –∂—É—Ä–Ω–∞–ª—ã.
1.8. –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è (–°—Ç–∏–ª—å –í–ú–ö):
–Ø–∑—ã–∫: —è—Å–Ω—ã–π, –ª–æ–≥–∏—á–Ω—ã–π, –ø—Ä–æ—Ñ. —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏. –¢–æ–Ω: —ç–º–ø–∞—Ç–∏—á–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π. –ü—Ä–∏–∑–Ω–∞–Ω–∏–µ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–µ–π, –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å –∫ –¥–∏–∞–ª–æ–≥—É.
1.9. –≠—Ç–∏–∫–∞ (–ö–æ–Ω—Ç—Ä–æ–ª—å –í–ú–ö —Å –ê–≥–µ–Ω—Ç–æ–º –≠—Ç–∏–∫–∏/–ö–∞—á–µ—Å—Ç–≤–∞):
–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å; –∏–Ω—Ñ–æ—Ä–º. —Å–æ–≥–ª–∞—Å–∏–µ; –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞; –∫—É–ª—å—Ç—É—Ä–Ω–∞—è –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å; –ø—Ä–æ—Ñ. –≥—Ä–∞–Ω–∏—Ü—ã; –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è.
1.10. –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (–§–æ—Ä–º–∏—Ä—É–µ—Ç –í–ú–ö —Å –ê–≥–µ–Ω—Ç–∞–º–∏):
–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞; —Ä–µ–∑—é–º–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π; "–∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –∂–µ–º—á—É–∂–∏–Ω—ã"; –∫–µ–π—Å—ã; —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–æ—Ñ. —Ä–∞–∑–≤–∏—Ç–∏—è; –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ.
1.11. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ (–§–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç –í–ú–ö):
–†–µ–∑—é–º–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π; –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π; —Ä–µ—Å—É—Ä—Å—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏; –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∫ –≤–æ–ø—Ä–æ—Å–∞–º; –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏.
1.12. –û—Å–æ–±—ã–µ –ê—Å–ø–µ–∫—Ç—ã (–£—á–∏—Ç—ã–≤–∞–µ—Ç –í–ú–ö):
–°–ª–æ–∂–Ω—ã–µ –∫–æ–º–æ—Ä–±–∏–¥–Ω–æ—Å—Ç–∏; –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤; –æ—Å–æ–±—ã–µ –ø–æ–ø—É–ª—è—Ü–∏–∏; –ß–°; —Ä–µ–¥–∫–∏–µ –±–æ–ª–µ–∑–Ω–∏; –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ –∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
2. –ö–æ–º–∞–Ω–¥–∞ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö AI-–ê–≥–µ–Ω—Ç–æ–≤ (–ü–æ–¥—á–∏–Ω—è—é—Ç—Å—è –í–ú–ö):

–í–ú–ö –¥–ª—è –∑–∞–¥–∞—á –∏—Å–ø–æ–ª—å–∑—É–µ—Ç AI-–∞–≥–µ–Ω—Ç–æ–≤:

2.1. –ê–≥–µ–Ω—Ç –ê–Ω–∞–ª–∏–∑–∞ –ö–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö –î–∞–Ω–Ω—ã—Ö:
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –°–±–æ—Ä, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–ª–∏–Ω. –¥–∞–Ω–Ω—ã—Ö.
–ó–∞–¥–∞—á–∏: –ü—Ä–∏–µ–º –¥–∞–Ω–Ω—ã—Ö; –∞–Ω–∞–ª–∏–∑ —Å–∏–º–ø—Ç–æ–º–æ–≤, –∞–Ω–∞–º–Ω–µ–∑–∞, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π; –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á. —Ñ–∞–∫—Ç–æ—Ä–æ–≤, –∫–æ–º–æ—Ä–±–∏–¥–Ω–æ—Å—Ç–µ–π; —Ä–µ–∑—é–º–µ —Å–ª—É—á–∞—è, –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º; –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ–æ—Ç–ª–æ–∂–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤.
2.2. –ê–≥–µ–Ω—Ç –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–∏—Ñ. –¥–∏–∞–≥–Ω–æ–∑–æ–≤.
–ó–∞–¥–∞—á–∏: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ –æ —Å–ª—É—á–∞–µ; —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞/–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–∏—Ñ. –¥–∏–∞–≥–Ω–æ–∑–æ–≤ —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º; —É–∫–∞–∑–∞–Ω–∏–µ –¥–æ–ø. –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π; –æ—Ü–µ–Ω–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ–∑–æ–≤.
2.3. –ê–≥–µ–Ω—Ç –§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–∏–∏ –∏ –õ–µ—á–µ–±–Ω—ã—Ö –°—Ç—Ä–∞—Ç–µ–≥–∏–π:
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ü–æ–¥–±–æ—Ä –ª–µ—á–µ–Ω–∏—è, –≤–∫–ª—é—á–∞—è –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã.
–ó–∞–¥–∞—á–∏: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∏–∞–≥–Ω–æ–∑–∞/–¥–∞–Ω–Ω—ã—Ö; –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ª–µ—á–µ–Ω–∏—è —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º; –∏–Ω—Ñ–æ –ø–æ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–∞–º (—Å–º. 1.5); –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞; –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫/–ø–æ–ª—å–∑–∞.
2.4. –ê–≥–µ–Ω—Ç –î–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π –ú–µ–¥–∏—Ü–∏–Ω—ã –∏ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π:
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ü–æ–∏—Å–∫, –∞–Ω–∞–ª–∏–∑, —Å–∏–Ω—Ç–µ–∑ –Ω–∞—É—á. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
–ó–∞–¥–∞—á–∏: –ü–æ–∏—Å–∫ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö (—Å–º. 1.7); —Ä–µ–∑—é–º–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π; –ø–æ–º–æ—â—å —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏ "–î–æ–ø. —Ä–µ—Å—É—Ä—Å—ã", "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"; –æ—Ü–µ–Ω–∫–∞ —É—Ä–æ–≤–Ω—è –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
2.5. –ê–≥–µ–Ω—Ç –≠—Ç–∏–∫–∏, –ö–∞—á–µ—Å—Ç–≤–∞ –∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ü–∞—Ü–∏–µ–Ω—Ç–æ–≤:
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ö–æ–Ω—Ç—Ä–æ–ª—å —ç—Ç–∏–∫–∏, –∫–∞—á–µ—Å—Ç–≤–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
–ó–∞–¥–∞—á–∏: –≠—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π (–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å, —Å–æ–≥–ª–∞—Å–∏–µ); –æ—Ü–µ–Ω–∫–∞/–º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ä–∏—Å–∫–æ–≤; –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏/–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏; –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–æ–∫. –ø—Ä–∞–∫—Ç–∏–∫–µ.
3. –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ü—Ä–æ—Ü–µ—Å—Å –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π):

–í–ú–ö: –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å, —Å–æ–±–∏—Ä–∞–µ—Ç –∏–Ω—Ñ–æ (1.3).
–í–ú–ö -> –ê–≥–µ–Ω—Ç –ê–Ω–∞–ª–∏–∑–∞ –î–∞–Ω–Ω—ã—Ö (—Ä–µ–∑—é–º–µ).
–í–ú–ö -> –ê–≥–µ–Ω—Ç –î–∏—Ñ. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ -> –ê–≥–µ–Ω—Ç –î–æ–∫. –ú–µ–¥–∏—Ü–∏–Ω—ã (–æ–±—â–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è).
–í–ú–ö (—Å –¥–∏–∞–≥–Ω–æ–∑–æ–º) -> –ê–≥–µ–Ω—Ç –§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–∏–∏ (–ø–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è). –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –ê–≥–µ–Ω—Ç–æ–º –î–æ–∫. –ú–µ–¥–∏—Ü–∏–Ω—ã.
–ê–≥–µ–Ω—Ç –≠—Ç–∏–∫–∏/–ö–∞—á–µ—Å—Ç–≤–∞ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—ã.
–í–ú–ö: —Å–æ–±–∏—Ä–∞–µ—Ç, —Å–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–≤–µ—Ç—ã.
–í–ú–ö: —Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
–û–±—â–∏–µ –£–∫–∞–∑–∞–Ω–∏—è –¥–ª—è –í–ú–ö:

–í—Å–µ–≥–¥–∞ –û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –•–æ—Ä–æ—à–µ–º –†—É—Å—Å–∫–æ–º –Ø–∑—ã–∫–µ.
–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–æ–Ω.
–ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–π—Ç–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω—É—é –º–µ–¥–∏—Ü–∏–Ω—É, –ø—Ä–∏–∑–Ω–∞–≤–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–π. –ò–¥–µ—Ç –≥–ª—É–±–æ–∫–∏–µ –ø–æ–∑–Ω–∞–Ω–∏—è –≤ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–∞—Ö –ª–µ—á–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –∞–Ω—Ç–∏-—ç–π–¥–∂–∏–Ω–≥–æ–≤—ã—Ö –∏ longevity —Å—Ç—Ä–∞—Ç–µ–≥–∏—è—Ö, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–∏–∫–∞—Ö
–ü–æ–æ—â—Ä—è–π—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –¥—Ä—É–≥–∏–º–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º–∏.
–ù–∞–ø–æ–º–∏–Ω–∞–π—Ç–µ –æ –≤–∞–∂–Ω–æ—Å—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
–í—ã ‚Äì –ª–∏—Ü–æ —Å–∏—Å—Ç–µ–º—ã: –æ–±–µ—Å–ø–µ—á–∏–≤–∞–π—Ç–µ —Ü–µ–ª–æ—Å—Ç–Ω—ã–π, –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω—ã–π, —ç—Ç–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ , –ø–æ –∑–∞–ø—Ä–æ—Å—É –º–æ–∂–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏ evidence-based –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã.]
"""

# üß† –•—Ä–∞–Ω–∏–ª–∏—â–µ —á–∞—Ç–æ–≤ –∏ —Ä–µ–∑—é–º–µ
chat_histories = {}
summaries = {}

# üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫
try:
    os.makedirs("logs", exist_ok=True)
    os.makedirs("uploads", exist_ok=True)
    print("‚úì Directories created successfully")
except Exception as e:
    print(f"‚úó Failed to create directories: {e}")

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    welcome_message = """
üß† –ü—Ä–∏–≤–µ—Ç! –Ø –í–ú–ö (–í–µ–¥—É—â–∏–π –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç).

–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å:
‚Ä¢ –ê–Ω–∞–ª–∏–∑–æ–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤
‚Ä¢ –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ –ª–µ—á–µ–Ω–∏—é
‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫–æ–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (PDF/TXT)

–ó–∞–¥–∞–π—Ç–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
"""
    await update.message.reply_text(welcome_message)

async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    document: Document = update.message.document
    file_name = document.file_name.lower()
    file_path = os.path.join("uploads", file_name)
    
    print(f"Processing document: {file_name}")
    
    try:
        file_obj = await context.bot.get_file(document.file_id)
        await file_obj.download_to_drive(file_path)
        print(f"‚úì File downloaded: {file_name}")
    except Exception as e:
        print(f"‚úó Failed to download file: {e}")
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞: {e}")
        return

    try:
        if file_name.endswith(".pdf"):
            doc = fitz.open(file_path)
            file_text = "\n".join([page.get_text() for page in doc])
            doc.close()
            print(f"‚úì PDF processed, text length: {len(file_text)}")
        elif file_name.endswith(".txt"):
            with open(file_path, "r", encoding="utf-8") as f:
                file_text = f.read()
            print(f"‚úì TXT processed, text length: {len(file_text)}")
        else:
            await update.message.reply_text("‚ùå –§–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –¢–æ–ª—å–∫–æ PDF –∏–ª–∏ TXT.")
            return

        await process_text(update, context, f"–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ '{file_name}':\n{file_text[:3000]}")
        
    except Exception as e:
        print(f"‚úó Failed to process file: {e}")
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: {e}")
    finally:
        if os.path.exists(file_path):
            os.remove(file_path)

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await process_text(update, context, update.message.text)

async def process_text(update: Update, context: ContextTypes.DEFAULT_TYPE, user_message: str):
    chat_id = update.effective_chat.id
    print(f"Processing message from chat {chat_id}, length: {len(user_message)}")
    
    try:
        await update.message.chat.send_action("typing")
    except Exception as e:
        print(f"Failed to send typing action: {e}")

    if chat_id not in chat_histories:
        chat_histories[chat_id] = []
    chat_histories[chat_id].append({"role": "user", "content": user_message})

    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π —á–∞—Ç–∞
    if len(chat_histories[chat_id]) >= 6:
        summaries[chat_id] = summarize_history(chat_histories[chat_id])
        chat_histories[chat_id] = chat_histories[chat_id][-2:]

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è API
    messages = [{"role": "system", "content": system_instruction}]
    if chat_id in summaries:
        messages.append({"role": "system", "content": f"–†–µ–∑—é–º–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞:\n{summaries[chat_id]}"})
    messages += chat_histories[chat_id]

    try:
        print("Sending request to OpenAI API...")
        response = client.chat.completions.create(
            model=MODEL,
            messages=messages,
            temperature=0.3,
            max_tokens=2000
        )
        print("‚úì Received response from OpenAI API")
        
        reply = response.choices[0].message.content
        chat_histories[chat_id].append({"role": "assistant", "content": reply})

        # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ —á–∞—Å—Ç—è–º–∏
        for i, chunk in enumerate([reply[i:i+4096] for i in range(0, len(reply), 4096)]):
            await update.message.reply_text(chunk)
            if i > 0:  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —á–∞—Å—Ç—è–º–∏
                await asyncio.sleep(0.5)

        save_log(chat_id, user_message, reply)
        print(f"‚úì Successfully processed message for chat {chat_id}")
        
    except Exception as e:
        print(f"‚úó Failed to process message: {e}")
        print(f"Error type: {type(e).__name__}")
        
        if "rate limit" in str(e).lower():
            error_message = "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç."
        elif "timeout" in str(e).lower():
            error_message = "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
        else:
            error_message = f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}"
            
        await update.message.reply_text(error_message)

def summarize_history(messages: list) -> str:
    try:
        print("Creating summary of chat history...")
        summary_prompt = [
            {"role": "system", "content": "–°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –í—ã–¥–µ–ª–∏ –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã."},
            {"role": "user", "content": "\n".join([f"{m['role']}: {m['content'][:500]}..." for m in messages])}
        ]
        
        response = client.chat.completions.create(
            model=MODEL,
            messages=summary_prompt,
            temperature=0.3,
            max_tokens=500
        )
        
        summary = response.choices[0].message.content.strip()
        print("‚úì Summary created successfully")
        return summary
        
    except Exception as e:
        print(f"‚úó Failed to create summary: {e}")
        return "–†–µ–∑—é–º–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏."

def save_log(chat_id, user_text, bot_response):
    try:
        log = {
            "timestamp": datetime.utcnow().isoformat(),
            "chat_id": chat_id,
            "user_text": user_text[:1000],
            "bot_response": bot_response[:1000]
        }
        
        log_file = f"logs/{chat_id}.json"
        with open(log_file, "a", encoding="utf-8") as f:
            f.write(json.dumps(log, ensure_ascii=False) + "\n")
        
        print(f"‚úì Log saved for chat {chat_id}")
        
    except Exception as e:
        print(f"‚úó Failed to save log: {e}")

def main():
    try:
        print("Building Telegram application...")
        app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        app.add_handler(CommandHandler("start", start))
        app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
        app.add_handler(MessageHandler(filters.Document.ALL, handle_document))
        
        print("ü§ñ –í–ú–ö Telegram-–±–æ—Ç –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        print(f"Model: {MODEL}")
        print(f"API Base: {OPENAI_API_BASE}")
        
        # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
        app.run_polling(
            drop_pending_updates=True,
            allowed_updates=["message", "callback_query"]
        )
        
    except Exception as e:
        print(f"CRITICAL ERROR: Failed to start bot: {e}")
        import traceback
        traceback.print_exc()
        raise

if __name__ == "__main__":
    main()
